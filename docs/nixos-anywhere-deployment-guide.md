# NixOS-Anywhere Deployment Guide

## Overview

This guide provides step-by-step instructions for deploying NixOS to the ASUS NUC homelab using nixos-anywhere. The configuration has been analyzed and is **compatible with nixos-anywhere** with no code changes required.

**‚úÖ macOS Compatibility**: This deployment method works seamlessly from macOS (both Intel and Apple Silicon). See [macOS Deployment Notes](#macos-deployment-notes) for platform-specific guidance.

## Target System Information

- **Target IP**: 192.168.0.134
- **SSH User**: root
- **Authentication**: Password-based
- **System State**: Fresh installation (NixOS installer ISO booted with SSH enabled)
- **Hostname**: nuc-server

## Configuration Analysis Results

### ‚úÖ flake.nix - COMPATIBLE
- Properly structured with `nixosConfigurations.nuc-server` output
- Includes disko module correctly
- Uses nixos-unstable for latest hardware support
- Correctly configured for x86_64-linux architecture

### ‚úÖ disko-config.nix - COMPATIBLE
- Uses disk-by-id paths (reliable for remote deployment)
- Declaratively defines:
  - 1GB EFI boot partition on NVMe
  - ext4 root filesystem on NVMe
  - ZFS storage pool on 20TB USB HDD
- Proper ZFS pool options configured

### ‚úÖ configuration.nix - COMPATIBLE
- SSH enabled (required for nixos-anywhere)
- Includes disko-config.nix
- ZFS support properly configured
- User account (somesh) with wheel group access
- Flakes and nix-command enabled

### ‚úÖ hardware-configuration.nix - AUTO-GENERATED
- Will be automatically generated by nixos-anywhere during deployment
- Current file serves as reference only

## Prerequisites

### On Your Local Machine (Deployment Machine)

1. **nixos-anywhere** (no installation needed - will be run via `nix run`):
   - Works on **Linux** (NixOS, Ubuntu, etc.)
   - Works on **macOS** (both Intel and Apple Silicon)
   - No pre-installation required when using `nix run`

2. **Nix package manager**:
   - On macOS: [Install Nix](https://nixos.org/download.html) (if not already installed)
   - Experimental features required: `nix-command` and `flakes`

3. **Verify SSH connectivity** to the target machine:
   ```bash
   ssh root@192.168.0.134
   ```
   - You should be prompted for the root password
   - Test the connection and then exit

4. **Have your flake repository accessible**:
   - Current directory: `/Users/somesh/projects/experiments/nixos-homelab-v2`
   - Ensure you're in this directory or have the path ready

### On Target Machine (192.168.0.134)

The target machine should already have:
- ‚úÖ NixOS installer ISO booted
- ‚úÖ Network connectivity established
- ‚úÖ SSH service enabled
- ‚úÖ Root password set

## Required Configuration Changes

### üéâ NO CHANGES REQUIRED!

Your configuration is already fully compatible with nixos-anywhere. The setup includes:
- Proper flake structure with nixosConfigurations output
- Valid disko configuration for declarative partitioning
- SSH enabled in configuration.nix
- All necessary modules imported correctly

## Step-by-Step Deployment Instructions

### Step 1: Verify Prerequisites

From your local machine, confirm:

```bash
# 1. Test SSH connectivity
ssh root@192.168.0.134
# Enter password when prompted, then type 'exit' to return to local machine

# 2. Verify you're in the correct directory
cd /Users/somesh/projects/experiments/nixos-homelab-v2
pwd  # Should show: /Users/somesh/projects/experiments/nixos-homelab-v2

# 3. Verify flake is valid
nix flake show
```

Expected output:
```
‚îî‚îÄ‚îÄ‚îÄnixosConfigurations
    ‚îî‚îÄ‚îÄ‚îÄnuc-server: NixOS configuration
```

### Step 2: Prepare for Deployment

**Important Pre-Deployment Checklist**:

1. ‚ö†Ô∏è  **BACKUP WARNING**: nixos-anywhere will **completely wipe** the target disks specified in disko-config.nix:
   - `/dev/disk/by-id/nvme-eui.e8238fa6bf530001001b448b47ee6f6a` (NVMe SSD)
   - `/dev/disk/by-id/usb-Seagate_Expansion_HDD_00000000NT17VP0M-0:0` (20TB HDD)

2. Verify the disk IDs are correct for your hardware:
   ```bash
   # On the target machine via SSH
   ssh root@192.168.0.134 "ls -la /dev/disk/by-id/"
   ```
   Compare the output with the disk IDs in [`disko-config.nix`](../disko-config.nix:10) (line 10 for NVMe, line 39 for HDD).

3. Ensure the target machine has sufficient power and stable network connection.

### Step 3: Execute nixos-anywhere Deployment

Run the following command from your **local machine** while in the project directory:

```bash
nix run --extra-experimental-features nix-command --extra-experimental-features flakes github:nix-community/nixos-anywhere -- \
  --flake .#nuc-server \
  --build-on-remote \
  root@192.168.0.134
```

**Command Breakdown**:
- `nix run github:nix-community/nixos-anywhere`: Downloads and runs the latest nixos-anywhere tool
- `--flake .#nuc-server`: Uses the flake in current directory (`.`) with the `nuc-server` configuration
- `--build-on-remote`: Builds the system on the target machine (recommended for different architectures, **required for macOS**)
- `root@192.168.0.134`: Target machine with root user authentication

**‚ö†Ô∏è IMPORTANT FOR macOS USERS:**
- **ALWAYS use** `github:nix-community/nixos-anywhere` (NOT `github:nix-community/disko`)
- **ALWAYS include** `--build-on-remote` flag when deploying from macOS
- This ensures Linux-specific build dependencies are handled on the target machine

**Alternative command without build-on-remote** (only if local machine is also x86_64-linux):
```bash
nix run --extra-experimental-features nix-command --extra-experimental-features flakes github:nix-community/nixos-anywhere -- \
  --flake .#nuc-server \
  root@192.168.0.134
```

### Step 4: Monitor the Deployment Process

The deployment will proceed through several phases:

1. **SSH Connection**: Establishes connection to root@192.168.0.134
   - You'll be prompted for the root password

2. **System Preparation**: Prepares the target environment

3. **Disk Partitioning**: Applies disko configuration
   - Creates GPT partition table on NVMe
   - Creates 1GB EFI boot partition
   - Creates ext4 root partition
   - Initializes ZFS pool on 20TB HDD

4. **Filesystem Mounting**: Mounts partitions to /mnt

5. **System Build**: 
   - Generates hardware-configuration.nix automatically
   - Builds the NixOS system according to configuration.nix
   - This may take 15-30 minutes depending on network speed

6. **System Installation**: Installs built system to /mnt

7. **Bootloader Installation**: Installs systemd-boot to EFI partition

**Expected output indicators**:
- `copying path '...'` - System packages being installed
- `building '/nix/store/...'` - System configuration being built
- `installation finished!` - Successful completion

### Step 5: Post-Deployment Verification

Once deployment completes successfully:

1. **Reboot the target machine**:
   ```bash
   ssh root@192.168.0.134 reboot
   ```

2. **Wait for system to boot** (approximately 1-2 minutes)

3. **Test SSH access with root**:
   ```bash
   ssh root@192.168.0.134
   ```

4. **Verify system information**:
   ```bash
   # Check hostname
   hostname
   # Expected: nuc-server
   
   # Check NixOS version
   nixos-version
   
   # Verify ZFS pool
   zpool status storagepool
   
   # Check mounted filesystems
   df -h
   ```

5. **Set user password** (currently user 'somesh' has no password):
   ```bash
   passwd somesh
   ```

6. **Test user login**:
   ```bash
   exit  # Exit root session
   ssh somesh@192.168.0.134
   ```

## Deployment Command Reference

### Basic Deployment (Recommended)
```bash
nix run --extra-experimental-features nix-command --extra-experimental-features flakes github:nix-community/nixos-anywhere -- \
  --flake .#nuc-server \
  --build-on-remote \
  root@192.168.0.134
```

### Using SSH Key Authentication (If configured later)
```bash
nix run --extra-experimental-features nix-command --extra-experimental-features flakes github:nix-community/nixos-anywhere -- \
  --flake .#nuc-server \
  --build-on-remote \
  root@192.168.0.134
```

### Debug Mode (Verbose output)
```bash
nix run --extra-experimental-features nix-command --extra-experimental-features flakes github:nix-community/nixos-anywhere -- \
  --flake .#nuc-server \
  --build-on-remote \
  --debug \
  root@192.168.0.134
```

### VM Test Mode (Test without actual installation)
```bash
nix run --extra-experimental-features nix-command --extra-experimental-features flakes github:nix-community/nixos-anywhere -- \
  --flake .#nuc-server \
  --vm-test
```

## Troubleshooting

### Issue: macOS Compatibility Error (Package 'acl-2.3.2' not available)

**Symptoms**:
```
error: Package 'acl-2.3.2' in /nix/store/... is not available on the requested hostPlatform:
  hostPlatform.config = "arm64-apple-darwin"
  package.meta.platforms = [ "aarch64-linux" ... ]
```

**Root Cause**:
This error occurs when using `github:nix-community/disko` instead of `github:nix-community/nixos-anywhere`. The disko tool has Linux-only dependencies (like 'acl') that cannot be evaluated on macOS, even when using `--build-on-remote`.

**Solution**:
Use the **correct** nixos-anywhere command:

```bash
# ‚úÖ CORRECT - Use nixos-anywhere (NOT disko)
nix run --extra-experimental-features nix-command --extra-experimental-features flakes github:nix-community/nixos-anywhere -- \
  --flake .#nuc-server \
  --build-on-remote \
  root@192.168.0.134

# ‚ùå WRONG - Don't use disko directly for deployment
nix run github:nix-community/disko -- \
  --flake .#nuc-server \
  --build-on-remote \
  root@192.168.0.134
```

**Why This Happens**:
- `nixos-anywhere` is the deployment tool that supports macOS hosts
- `disko` is the disk partitioning library used by nixos-anywhere
- Running disko directly requires Linux because it evaluates Linux-specific packages locally
- nixos-anywhere handles the platform differences correctly

**Key Points for macOS Users**:
- Always use `github:nix-community/nixos-anywhere`
- Always include `--build-on-remote` flag
- nixos-anywhere works natively on macOS (aarch64-darwin and x86_64-darwin)

### Issue: SSH Connection Fails

**Symptoms**:
```
ssh: connect to host 192.168.0.134 port 22: Connection refused
```

**Solutions**:
1. Verify target machine is powered on and network cable is connected
2. Check if SSH service is running on target:
   ```bash
   # From target machine console/keyboard
   systemctl status sshd
   ```
3. Verify IP address:
   ```bash
   # From target machine console
   ip addr show
   ```
4. Ensure no firewall is blocking port 22

### Issue: Authentication Failed

**Symptoms**:
```
Permission denied (publickey,password)
```

**Solutions**:
1. Verify you're using the correct root password
2. Ensure password authentication is enabled on target:
   ```bash
   # From target machine console
   grep PasswordAuthentication /etc/ssh/sshd_config
   # Should show: PasswordAuthentication yes
   ```
3. Restart SSH service if needed:
   ```bash
   systemctl restart sshd
   ```

### Issue: Disk Not Found

**Symptoms**:
```
error: Device '/dev/disk/by-id/nvme-eui.xxxxx' not found
```

**Solutions**:
1. SSH into target and list available disks:
   ```bash
   ssh root@192.168.0.134 "ls -la /dev/disk/by-id/"
   ```
2. Compare with disk IDs in [`disko-config.nix`](../disko-config.nix:10)
3. Update disko-config.nix with correct disk IDs if needed
4. Commit changes to Git and re-run deployment

### Issue: ZFS Module Not Available

**Symptoms**:
```
error: ZFS kernel module not found
```

**Solutions**:
1. Ensure target is booted from NixOS installer ISO (not another Linux)
2. Verify [`boot.initrd.kernelModules`](../hardware-configuration.nix:12) includes "zfs"
3. Check if ZFS is supported on installer:
   ```bash
   ssh root@192.168.0.134 "modprobe zfs && echo 'ZFS available'"
   ```

### Issue: USB Drive Not Detected

**Symptoms**:
- ZFS pool creation fails
- Device `/dev/disk/by-id/usb-Seagate_Expansion_HDD...` not found

**Solutions**:
1. Verify USB drive is connected and powered on
2. Check dmesg for USB detection:
   ```bash
   ssh root@192.168.0.134 "dmesg | grep -i usb"
   ```
3. List USB devices:
   ```bash
   ssh root@192.168.0.134 "lsusb"
   ```
4. Ensure USB drive has unique ID:
   ```bash
   ssh root@192.168.0.134 "ls -la /dev/disk/by-id/ | grep Seagate"
   ```
5. The [`configuration.nix`](../configuration.nix:35) includes USB device wait logic - verify it matches your device

### Issue: Build Fails Due to Network

**Symptoms**:
```
error: unable to download 'https://...'
```

**Solutions**:
1. Verify target machine has internet connectivity:
   ```bash
   ssh root@192.168.0.134 "ping -c 3 8.8.8.8"
   ```
2. Check DNS resolution:
   ```bash
   ssh root@192.168.0.134 "ping -c 3 nixos.org"
   ```
3. Use `--build-on-remote` flag to handle network better
4. Try deployment during off-peak hours for better download speeds

### Issue: Out of Disk Space During Build

**Symptoms**:
```
error: writing to file: No space left on device
```

**Solutions**:
1. The NixOS installer ISO runs in RAM - ensure target has sufficient RAM (8GB+ recommended)
2. Use `--build-on-remote` to build on target's disk instead of RAM
3. Alternatively, build locally first without remote build

### Issue: Flake Not Found

**Symptoms**:
```
error: getting status of '/nix/store/.../flake.nix': No such file or directory
```

**Solutions**:
1. Ensure you're in the correct directory:
   ```bash
   cd /Users/somesh/projects/experiments/nixos-homelab-v2
   ```
2. Verify flake.nix exists:
   ```bash
   ls -la flake.nix
   ```
3. Check Git status (uncommitted changes might not be included):
   ```bash
   git status
   ```
4. Commit any pending changes:
   ```bash
   git add .
   git commit -m "Update configuration"
   ```

### Recovery: Deployment Interrupted

If deployment is interrupted (power loss, network failure, etc.):

1. **DO NOT PANIC** - The target disk may be partially configured
2. **Reboot target machine** into installer ISO
3. **Check disk state**:
   ```bash
   ssh root@192.168.0.134 "lsblk"
   ```
4. **Re-run deployment** - disko will recreate partitions from scratch
5. The deployment is **idempotent** - safe to run multiple times

## Post-Deployment Next Steps

After successful deployment:

1. **Set secure passwords**:
   ```bash
   # For root user
   ssh root@192.168.0.134
   passwd  # Set strong root password
   
   # For regular user
   passwd somesh
   ```

2. **Configure SSH key authentication** (recommended):
   ```bash
   # Generate SSH key on local machine (if not already present)
   ssh-keygen -t ed25519 -C "your-email@example.com"
   
   # Copy public key to target
   ssh-copy-id somesh@192.168.0.134
   ```

3. **Update configuration** to disable password authentication:
   - Edit [`configuration.nix`](../configuration.nix)
   - Add SSH key to user configuration
   - Deploy updates using `nixos-rebuild`

4. **Verify ZFS pool health**:
   ```bash
   ssh root@192.168.0.134 "zpool status"
   ```

5. **Plan service deployments** according to [`docs/pre-service-deployment-plan.md`](pre-service-deployment-plan.md)

## Configuration Files Reference

- [`flake.nix`](../flake.nix) - Flake definition with nixosConfigurations
- [`configuration.nix`](../configuration.nix) - Main system configuration
- [`disko-config.nix`](../disko-config.nix) - Declarative disk partitioning
- [`hardware-configuration.nix`](../hardware-configuration.nix) - Auto-generated hardware config

## Additional Resources

- [nixos-anywhere Documentation](https://github.com/nix-community/nixos-anywhere)
- [disko Documentation](https://github.com/nix-community/disko)
- [NixOS Manual](https://nixos.org/manual/nixos/stable/)
- [Original Installation Instructions](os-install-instructions.md) - Manual installation reference

## macOS Deployment Notes

### Platform Support
nixos-anywhere fully supports deployment from macOS:
- ‚úÖ **Apple Silicon (M1/M2/M3)**: aarch64-darwin
- ‚úÖ **Intel Macs**: x86_64-darwin

### Critical Requirements for macOS
1. **Always use the correct tool**: `github:nix-community/nixos-anywhere` (NOT `disko`)
2. **Always use** `--build-on-remote`: This ensures Linux-specific packages are built on the target
3. **Include experimental features flags**: `--extra-experimental-features nix-command --extra-experimental-features flakes`

### Correct macOS Command
```bash
nix run --extra-experimental-features nix-command --extra-experimental-features flakes github:nix-community/nixos-anywhere -- \
  --flake .#nuc-server \
  --build-on-remote \
  root@192.168.0.134
```

### Why the Original Command Failed
The error `Package 'acl-2.3.2' is not available on arm64-apple-darwin` occurred because:
1. The guide incorrectly showed `github:nix-community/disko` instead of `github:nix-community/nixos-anywhere`
2. Running disko directly tries to evaluate Linux-only packages on macOS
3. nixos-anywhere handles platform differences and delegates Linux builds to the remote machine

### Verification
To verify nixos-anywhere is working on your macOS system:
```bash
nix --extra-experimental-features "nix-command flakes" run github:nix-community/nixos-anywhere -- --flake .#nuc-server --help
```

If this shows the help output without errors, your macOS system is ready for deployment.

## Summary

This deployment uses nixos-anywhere to:
1. ‚úÖ Connect to remote NixOS installer via SSH
2. ‚úÖ Apply declarative disk partitioning (disko)
3. ‚úÖ Generate hardware-configuration.nix automatically
4. ‚úÖ Build and install complete NixOS system
5. ‚úÖ Install bootloader and prepare for first boot

**Platform support**: Linux and macOS (Intel and Apple Silicon)

**Estimated deployment time**: 20-40 minutes (depending on network speed)

**Success criteria**: System boots into NixOS, SSH accessible, ZFS pool available at /data