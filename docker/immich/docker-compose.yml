# Immich Docker Compose Configuration
# ============================================================================
# Version: v2.5.6 (pinned for stability)
# Hardware: Intel N150 with Quick Sync (VAAPI) transcoding
# 
# This file is copied to /var/lib/immich/docker-compose.yml on deployment
# ============================================================================

name: immich

services:
  # ==========================================================================
  # IMMICH SERVER
  # ==========================================================================
  # Main API server - handles all web requests and background jobs
  immich-server:
    container_name: immich_server
    image: ghcr.io/immich-app/immich-server:${IMMICH_VERSION:-v2.5.6}
    
    # Intel Quick Sync hardware transcoding (VAAPI)
    devices:
      - /dev/dri:/dev/dri
    group_add:
      - "26"    # video
      - "303"   # render
    
    volumes:
      # Photo library - ZFS dataset on USB HDD
      - ${UPLOAD_LOCATION:-/data/immich/photos}:/usr/src/app/upload
      
      # Temporary upload location - ZFS dataset
      - /data/immich/upload:/usr/src/app/upload/upload
      
      # Timezone
      - /etc/localtime:/etc/localtime:ro
    
    env_file:
      - .env
    
    ports:
      - '2283:2283'
    
    depends_on:
      - redis
      - database
    
    restart: unless-stopped
    
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:2283/api/server/ping"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # ==========================================================================
  # IMMICH MACHINE LEARNING
  # ==========================================================================
  # Handles face detection, object recognition, smart search
  # Runs on CPU (N150 doesn't have dedicated GPU)
  immich-machine-learning:
    container_name: immich_machine_learning
    image: ghcr.io/immich-app/immich-machine-learning:${IMMICH_VERSION:-v2.5.6}
    
    volumes:
      # Model cache on NVMe SSD for fast loading
      - ${MODEL_CACHE_LOCATION:-/var/lib/immich/model-cache}:/cache
    
    env_file:
      - .env
    
    restart: unless-stopped
    
    healthcheck:
      test: ["CMD", "python3", "-c", "import requests; requests.get('http://localhost:3003/ping')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 120s

  # ==========================================================================
  # REDIS
  # ==========================================================================
  # Caching and job queue
  redis:
    container_name: immich_redis
    image: docker.io/valkey/valkey:8-alpine
    
    restart: unless-stopped
    
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ==========================================================================
  # POSTGRESQL DATABASE
  # ==========================================================================
  # Main database with pgvector for ML embeddings
  database:
    container_name: immich_postgres
    image: ghcr.io/immich-app/postgres:14-vectorchord0.4.3-pgvectors0.2.0
    
    environment:
      POSTGRES_PASSWORD: ${DB_PASSWORD}
      POSTGRES_USER: ${DB_USERNAME:-postgres}
      POSTGRES_DB: ${DB_DATABASE_NAME:-immich}
      POSTGRES_INITDB_ARGS: '--data-checksums'
      # Database on USB HDD - optimize for HDD access patterns
      DB_STORAGE_TYPE: ${DB_STORAGE_TYPE:-SSD}
    
    volumes:
      # Database on NVMe SSD for fast queries
      - ${DB_DATA_LOCATION:-/var/lib/immich/postgres}:/var/lib/postgresql/data
    
    # Shared memory for PostgreSQL
    shm_size: 256mb
    
    restart: unless-stopped
    
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_USERNAME:-postgres} -d ${DB_DATABASE_NAME:-immich}"]
      interval: 10s
      timeout: 5s
      retries: 5
